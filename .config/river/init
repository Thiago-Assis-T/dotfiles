#!/usr/bin/env bash

# Set up logging for debugging
exec 1>~/.local/share/river/init.log 2>&1
echo "River started at $(date)"

# Environment setup for better compatibility
export XDG_CURRENT_DESKTOP=river
export QT_QPA_PLATFORM=wayland
export MOZ_ENABLE_WAYLAND=1
export XDG_SESSION_TYPE=wayland
export QT_WAYLAND_CLIENT_BUFFER_INTEGRATION=wayland-egl
export QT_WAYLAND_SHELL_INTEGRATION=ivi-shell
export GDK_BACKEND=wayland
export SDL_VIDEODRIVER=wayland
export LIBVA_DRIVER_NAME=iHD
export _JAVA_AWT_WM_NONREPARENTING=1

# Start systemd graphical session
systemctl --user import-environment _JAVA_AWT_WM_NONREPARENTING LIBVA_DRIVER_NAME SDL_VIDEODRIVER GDK_BACKEND QT_WAYLAND_SHELL_INTEGRATION QT_WAYLAND_CLIENT_BUFFER_INTEGRATION WAYLAND_DISPLAY XDG_CURRENT_DESKTOP XDG_SESSION_TYPE QT_QPA_PLATFORM MOZ_ENABLE_WAYLAND
systemctl --user start graphical-session.target

# Start necessary services
dbus-launch --exit-with-session
dunst &
wl-paste -t text --watch clipman store &

# Set keyboard layout and repeat rate
riverctl keyboard-layout br
riverctl set-repeat 50 300

# Configure input devices
# Touchpad configuration (adjust device name as needed)
touchpad_device=$(riverctl list-inputs | grep -i touchpad | head -1 | cut -d' ' -f1)
if [ -n "$touchpad_device" ]; then
    riverctl input "$touchpad_device" \
        natural-scroll enabled \
        tap enabled \
        tap-button-map left-right-middle \
        accel-profile adaptive
fi

# Set flat acceleration for mice
riverctl input "type:pointer" accel-profile flat

# Set cursor theme (Breeze Dark)
riverctl cursor-theme "Breeze-Dark" 24

# TokyoNight color scheme
riverctl background-color 0x1a1b26       # TokyoNight background
riverctl border-color-focused 0x7aa2f7   # Blue
riverctl border-color-unfocused 0x414868 # Dark gray-blue
riverctl border-color-urgent 0xf7768e    # Red
riverctl border-width 2

# --- Keybindings ---
# Super+Shift+Return to start terminal
riverctl map normal Super+Shift Return spawn 'ghostty +new-window'

# Super+Q to close focused view
riverctl map normal Super Q close

# Super+W to open firefox
riverctl map normal Super W spawn firefox

# Super+E to open nemo (file manager)
riverctl map normal Super E spawn nemo

# Super+Shift+E to exit river
riverctl map normal Super+Shift E exit

riverctl map normal Super+Shift P spawn "systemctl --user start change-wallpaper.service"

# Application launcher (fuzzel)
riverctl map normal Super R spawn 'fuzzel'

# Lock screen (waylock)
riverctl map normal Super+Shift L spawn 'waylock'

# Reload river config
riverctl map normal Super+Shift C spawn 'pkill -USR1 river'
riverctl map normal Print spawn 'grim - | wl-copy && notify-send -a "Screenshot" "Fullscreen screenshot copied to clipboard"'
riverctl map normal Super+Print spawn 'grim -g "$(slurp)" - | wl-copy && notify-send -a "Screenshot" "Selection copied to clipboard"'
riverctl map normal Super+Shift+Print spawn 'grim -g "$(slurp)" "$HOME/Pictures/Screenshots/$(date +%Y%m%d_%H%M%S).png" && notify-send -a "Screenshot" "Selection saved to Pictures/Screenshots"'
# Volume control using wpctl (for PipeWire)
riverctl map normal None XF86AudioRaiseVolume spawn 'wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%+ && volume=$(wpctl get-volume @DEFAULT_AUDIO_SINK@ | cut -d" " -f2 | sed "s/\.//") && notify-send -a "Volume" "ðŸ”Š ${volume}%" -h int:value:$volume'
riverctl map normal None XF86AudioLowerVolume spawn 'wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%- && volume=$(wpctl get-volume @DEFAULT_AUDIO_SINK@ | cut -d" " -f2 | sed "s/\.//") && notify-send -a "Volume" "ðŸ”Š ${volume}%" -h int:value:$volume'
riverctl map normal None XF86AudioMute spawn 'wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle && if wpctl get-volume @DEFAULT_AUDIO_SINK@ | grep -q MUTED; then notify-send -a "Volume" "ðŸ”‡ Muted"; else volume=$(wpctl get-volume @DEFAULT_AUDIO_SINK@ | cut -d" " -f2 | sed "s/\.//") && notify-send -a "Volume" "ðŸ”Š ${volume}%" -h int:value:$volume; fi'

# Media controls with notifications
riverctl map normal None XF86AudioMedia spawn 'playerctl play-pause && notify-send -a "Media" "$(playerctl metadata --format "{{status}}")" -h string:x-canonical-private-synchronous:media'
riverctl map normal None XF86AudioPlay spawn 'playerctl play-pause && notify-send -a "Media" "$(playerctl metadata --format "{{status}}")"'
riverctl map normal None XF86AudioPrev spawn 'playerctl previous && notify-send -a "Media" "Previous track"'
riverctl map normal None XF86AudioNext spawn 'playerctl next && notify-send -a "Media" "Next track"'

# Brightness control with proper percentage calculation
riverctl map normal None XF86MonBrightnessUp spawn 'brightnessctl set +5% && current=$(brightnessctl -m | cut -d, -f4 | tr -d "%") && notify-send -a "Brightness" "$current%" -h int:value:$current'
riverctl map normal None XF86MonBrightnessDown spawn 'brightnessctl set 5%- && current=$(brightnessctl -m | cut -d, -f4 | tr -d "%") && notify-send -a "Brightness" "$current%" -h int:value:$current'

# Dunst control keybindings
riverctl map normal Super+Shift D spawn 'dunstctl close'
riverctl map normal Super+Ctrl D spawn 'dunstctl close-all'
riverctl map normal Super+Alt D spawn 'dunstctl context'
riverctl map normal Super+Shift+N spawn 'notify-send -t 5000 "Test Notification" "This is a test notification from River"'

# Navigation and window management
riverctl map normal Super J focus-view next
riverctl map normal Super K focus-view previous
riverctl map normal Super+Shift J swap next
riverctl map normal Super+Shift K swap previous

# Output navigation
riverctl map normal Super Period focus-output next
riverctl map normal Super Comma focus-output previous
riverctl map normal Super+Shift Period send-to-output next
riverctl map normal Super+Shift Comma send-to-output previous

# Layout control
riverctl map normal Super H send-layout-cmd rivertile "main-ratio -0.05"
riverctl map normal Super L send-layout-cmd rivertile "main-ratio +0.05"
riverctl map normal Super+Shift H send-layout-cmd rivertile "main-count +1"
riverctl map normal Super+Shift L send-layout-cmd rivertile "main-count -1"

# Move windows
riverctl map normal Super+Alt H move left 100
riverctl map normal Super+Alt J move down 100
riverctl map normal Super+Alt K move up 100
riverctl map normal Super+Alt L move right 100

# Snap windows to edges
riverctl map normal Super+Alt+Control H snap left
riverctl map normal Super+Alt+Control J snap down
riverctl map normal Super+Alt+Control K snap up
riverctl map normal Super+Alt+Control L snap right

# Resize windows
riverctl map normal Super+Alt+Shift H resize horizontal -100
riverctl map normal Super+Alt+Shift J resize vertical 100
riverctl map normal Super+Alt+Shift K resize vertical -100
riverctl map normal Super+Alt+Shift L resize horizontal 100

# Mouse bindings
riverctl map-pointer normal Super BTN_LEFT move-view
riverctl map-pointer normal Super BTN_RIGHT resize-view
riverctl map-pointer normal Super BTN_MIDDLE toggle-float

# Tag management (1-9)
for i in $(seq 1 9); do
    tags=$((1 << ($i - 1)))
    riverctl map normal Super $i set-focused-tags $tags
    riverctl map normal Super+Shift $i set-view-tags $tags
    riverctl map normal Super+Control $i toggle-focused-tags $tags
    riverctl map normal Super+Shift+Control $i toggle-view-tags $tags
done

# Tag 0 for all tags
all_tags=$(((1 << 32) - 1))
riverctl map normal Super 0 set-focused-tags $all_tags
riverctl map normal Super+Shift 0 set-view-tags $all_tags

# Toggle float and fullscreen
riverctl map normal Super Space toggle-float
riverctl map normal Super F toggle-fullscreen

# Layout orientation
riverctl map normal Super Up send-layout-cmd rivertile "main-location top"
riverctl map normal Super Right send-layout-cmd rivertile "main-location right"
riverctl map normal Super Down send-layout-cmd rivertile "main-location bottom"
riverctl map normal Super Left send-layout-cmd rivertile "main-location left"

# Passthrough mode
riverctl declare-mode passthrough
riverctl map normal Super F11 enter-mode passthrough
riverctl map passthrough Super F11 enter-mode normal

# --- Window Rules ---
# Float common utility windows
riverctl rule-add -app-id "pavucontrol" float
riverctl rule-add -app-id "nm-connection-editor" float
riverctl rule-add -app-id "blueman-manager" float
riverctl rule-add -title "File Operation Progress" float
riverctl rule-add -title "*Save As*" float
riverctl rule-add -title "*Open File*" float

# Assign applications to specific tags
riverctl rule-add -app-id "firefox" -tags 1
riverctl rule-add -title "YouTube Music" -tags 9
riverctl rule-add -app-id "nemo" -tags 3

# Start rivertile layout
riverctl default-layout rivertile
rivertile -view-padding 6 -outer-padding 6 &

# Final notification
notify-send -t 2000 "River" "Compositor initialized successfully"
